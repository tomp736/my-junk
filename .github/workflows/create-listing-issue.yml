name: On PR Merge - Create Listing Issue

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create-listing-issue:
    if: github.event.pull_request.merged == true && contains(toJSON(github.event.pull_request.labels.*.name), 'new-item')
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_APP_AUTOMATION_APP_ID }}
          private-key: ${{ secrets.GH_APP_AUTOMATION_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          ref: main

      - name: Extract item details from PR
        id: extract-item
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          result-encoding: string
          script: |
            const fs = require('fs');
            const path = require('path');

            // Get the files changed in the PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            console.log(`Found ${files.length} files in PR`);
            files.forEach(f => {
              console.log(`  - ${f.filename} (status: ${f.status})`);
            });

            // Find the item JSON file - look for added or modified files in items/ directory
            const itemFile = files.find(f =>
              f.filename.startsWith('items/') &&
              f.filename.endsWith('.json') &&
              !f.filename.includes('example-item.json') &&
              (f.status === 'added' || f.status === 'modified')
            );

            if (!itemFile) {
              console.log('No new item file found in PR');
              console.log('Looking for: items/*.json with status "added" or "modified"');
              return JSON.stringify({ found: false });
            }

            console.log(`Found item file: ${itemFile.filename}`);

            // Read the item JSON
            const itemContent = fs.readFileSync(itemFile.filename, 'utf8');
            const item = JSON.parse(itemContent);

            console.log(`Extracted item: ${item.id}`);

            // Convert relative image paths to absolute GitHub URLs
            const images = (item.images || []).map(img => 
              `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/${img}`
            );

            return JSON.stringify({
              found: true,
              itemId: item.id,
              titleEn: item.title.en,
              titlePl: item.title.pl,
              descriptionEn: item.description.en,
              descriptionPl: item.description.pl,
              images
            });

      - name: Parse extraction result
        id: parse-result
        if: steps.extract-item.outcome == 'success'
        run: |
          # Read the JSON result from the previous step into a shell variable
          RESULT='${{ steps.extract-item.outputs.result }}'

          # Print raw result to the job log for debugging (do NOT write this to $GITHUB_OUTPUT since it may contain newlines)
          echo "Raw extract-item result:" >&2
          printf '%s\n' "$RESULT" >&2

          # Extract the 'found' flag
          FOUND=$(echo "$RESULT" | jq -r '.found')
          echo "found=$FOUND" >> $GITHUB_OUTPUT

          if [ "$FOUND" = "true" ]; then
            # Safely extract each field (they may contain newlines)
            ITEM_ID=$(echo "$RESULT" | jq -r '.itemId')
            TITLE_EN=$(echo "$RESULT" | jq -r '.titleEn')
            TITLE_PL=$(echo "$RESULT" | jq -r '.titlePl')
            DESCRIPTION_EN=$(echo "$RESULT" | jq -r '.descriptionEn')
            DESCRIPTION_PL=$(echo "$RESULT" | jq -r '.descriptionPl')

            # Write single-line value
            echo "itemId=$ITEM_ID" >> $GITHUB_OUTPUT

            # Write multi-line values using the multiline output syntax
            echo "titleEn<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "$TITLE_EN" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "titlePl<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "$TITLE_PL" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "descriptionEn<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "$DESCRIPTION_EN" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "descriptionPl<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "$DESCRIPTION_PL" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Extract and write images array
            echo "images<<EOF" >> $GITHUB_OUTPUT
            echo "$RESULT" | jq -r '.images[]' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create listing issue
        if: steps.parse-result.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            // Use JavaScript template literals (backticks) for multi-line strings
            const itemId = `${{ steps.parse-result.outputs.itemId }}`;
            const titleEn = `${{ steps.parse-result.outputs.titleEn }}`;
            const titlePl = `${{ steps.parse-result.outputs.titlePl }}`;
            const descriptionEn = `${{ steps.parse-result.outputs.descriptionEn }}`;
            const descriptionPl = `${{ steps.parse-result.outputs.descriptionPl }}`;
            const images = `${{ steps.parse-result.outputs.images }}`.split('\n').filter(Boolean);

            // Ensure all inputs are properly escaped for the issue body
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Create listing for: ${titleEn.trim()}`,
              labels: ['listing-needed'],
              body: `## Create Listing

            Item has been added to the repository. Please create a listing on your preferred marketplace.

            ### Item Details

            **Item ID:** \`${itemId}\`
            **Title (EN):** ${titleEn}
            **Title (PL):** ${titlePl}

            **Description (EN):**
            ${descriptionEn}

            **Description (PL):**
            ${descriptionPl}

            ### Images
            ${images.map(img => `![Product Image](${img})`).join('\n')}

            ### Instructions
            1. Create a listing on your marketplace (OLX, Allegro, Facebook, etc.)
            2. **IMPORTANT:** Include this marker in the listing description: \`#!#${itemId}#!#\`
               - You can put it anywhere in the description (it can be hidden at the end)
               - This marker is used to verify the listing
            3. Once the listing is live, add a comment to this issue with the listing URL
            4. The GitHub Action will automatically verify the listing
            5. This issue will remain open until the validation PR is merged

            ### Supported Marketplaces

            - OLX.pl
            - Allegro.pl
            - Facebook Marketplace
            - Other

            ### Comment Format

            Add a comment with this format:
            \`\`\`
            Listing URL: https://example.com/listing/12345
            \`\`\`

            **Note:** Don't close the issue - it will close automatically after validation!
            `
            });

            console.log(`Created listing issue #${issue.data.number}`);
